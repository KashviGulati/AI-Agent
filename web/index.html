<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Document Intelligence & Data Analysis System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .data-analysis-section {
            grid-column: 1 / -1;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }

        .upload-section, .query-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #94a3b8;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #64748b;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-success:hover {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-warning:hover {
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .query-input {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
            margin-bottom: 20px;
        }

        .query-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .query-input::placeholder {
            color: #94a3b8;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
            margin-bottom: 15px;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .select-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background: white;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .results-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .answer-box {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            line-height: 1.8;
        }

        .sources-section {
            margin-top: 20px;
        }

        .source-item {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .source-filename {
            font-weight: 600;
            color: #1e293b;
        }

        .source-score {
            background: #eff6ff;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981);
            transition: width 0.5s ease;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status-success {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .status-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #e2e8f0;
        }

        .file-item.data-file {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 0.8rem;
            color: #64748b;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .data-analysis-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analysis-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .analysis-card h4 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .analysis-card p {
            color: #64748b;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .analysis-results {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .ml-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }

            .data-analysis-controls {
                grid-template-columns: 1fr;
            }

            .ml-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Enhanced Document Intelligence & Data Analysis System</h1>
            <p>Upload documents for intelligent querying and CSV/Excel files for comprehensive data analysis</p>
        </div>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="upload-section">
                <h2 class="section-title">📄 Upload Documents</h2>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Drop files here or click to browse</div>
                    <div class="upload-subtext">Supports PDF, DOCX, PPTX, TXT, CSV, Excel files</div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" 
                       accept=".pdf,.docx,.doc,.pptx,.ppt,.txt,.csv,.xlsx,.xls" multiple>
                
                <div class="file-list" id="fileList"></div>
                
                <button class="btn btn-secondary" id="refreshFiles">
                    <span>🔄</span> Refresh File List
                </button>
            </div>

            <!-- Query Section -->
            <div class="query-section">
                <h2 class="section-title">❓ Ask Questions</h2>
                
                <textarea 
                    id="queryInput" 
                    class="query-input" 
                    placeholder="Ask anything about your uploaded documents...

Examples:
• Summarize the main points
• What are the key findings?
• Explain the methodology used
• Compare different sections"></textarea>
                
                <button class="btn" id="submitQuery">
                    <span>🔍</span> Ask Question
                </button>
            </div>
        </div>

        <!-- Data Analysis Section -->
        <div class="data-analysis-section" id="dataAnalysisSection">
            <h2 class="section-title">📊 Data Analysis & Visualization</h2>
            <p>Comprehensive analysis tools for your CSV and Excel files</p>
            
            <div class="form-group">
                <label class="form-label">Select Data File:</label>
                <select id="dataFileSelect" class="select-field">
                    <option value="">Choose a data file...</option>
                </select>
            </div>

            <div class="data-analysis-controls" id="analysisControls">
                <div class="analysis-card">
                    <h4>📈 Exploratory Data Analysis (EDA)</h4>
                    <p>Get comprehensive statistical insights, data quality metrics, and basic visualizations</p>
                    <button class="btn btn-success" id="performEDA">
                        <span>📊</span> Perform EDA
                    </button>
                </div>

                <div class="analysis-card">
                    <h4>🤖 Machine Learning Training</h4>
                    <p>Train classification or regression models on your dataset</p>
                    <div class="ml-form">
                        <div class="form-group">
                            <label class="form-label">Target Column:</label>
                            <select id="targetColumn" class="select-field">
                                <option value="">Select target column...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Task Type:</label>
                            <select id="taskType" class="select-field">
                                <option value="auto">Auto-detect</option>
                                <option value="classification">Classification</option>
                                <option value="regression">Regression</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-warning" id="trainML">
                        <span>🤖</span> Train Models
                    </button>
                </div>

                <div class="analysis-card">
                    <h4>🎯 Clustering Analysis</h4>
                    <p>Discover hidden patterns and group similar data points</p>
                    <div class="form-group">
                        <label class="form-label">Number of Clusters (optional):</label>
                        <input type="number" id="numClusters" class="input-field" placeholder="Auto-detect optimal">
                    </div>
                    <button class="btn btn-success" id="performClustering">
                        <span>🎯</span> Perform Clustering
                    </button>
                </div>

                <div class="analysis-card">
                    <h4>📈 Advanced Visualizations</h4>
                    <p>Create interactive charts and advanced data visualizations</p>
                    <button class="btn btn-warning" id="createVisualizations">
                        <span>📈</span> Generate Charts
                    </button>
                </div>

                <div class="analysis-card">
                    <h4>🎨 GAN Visualization</h4>
                    <p>Generate synthetic data visualizations using Generative Adversarial Networks</p>
                    <button class="btn btn-danger" id="generateGAN">
                        <span>🎨</span> GAN Visualization
                    </button>
                </div>

                <div class="analysis-card">
                    <h4>🧠 AI Data Insights</h4>
                    <p>Get AI-powered insights and recommendations about your dataset</p>
                    <button class="btn" id="getInsights">
                        <span>🧠</span> Get Insights
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <h2 class="section-title">💡 Results</h2>
            
            <div id="statusMessage"></div>
            
            <div class="answer-box" id="answerBox"></div>
            
            <div class="confidence-meter" id="confidenceMeter" style="display: none;">
                <span>Confidence:</span>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                </div>
                <span id="confidenceText">0%</span>
            </div>
            
            <div class="sources-section" id="sourcesSection" style="display: none;">
                <h3>📚 Sources</h3>
                <div id="sourcesList"></div>
            </div>

            <div class="analysis-results" id="analysisResults" style="display: none;">
                <h3>📊 Analysis Results</h3>
                <div id="analysisContent"></div>
            </div>
        </div>
    </div>

    <script>
        class EnhancedRAGInterface {
            constructor() {
                this.baseUrl = 'http://localhost:8000';
                this.dataFiles = new Map();
                this.initializeEventListeners();
                this.loadFileList();
            }

            initializeEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const submitQuery = document.getElementById('submitQuery');
                const refreshFiles = document.getElementById('refreshFiles');
                const queryInput = document.getElementById('queryInput');

                // Upload area interactions
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                uploadArea.addEventListener('drop', this.handleDrop.bind(this));

                // File input change
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                // Query submission
                submitQuery.addEventListener('click', this.submitQuery.bind(this));
                queryInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        this.submitQuery();
                    }
                });

                // Refresh files
                refreshFiles.addEventListener('click', this.loadFileList.bind(this));

                // Data Analysis Event Listeners
                document.getElementById('dataFileSelect').addEventListener('change', this.handleDataFileSelection.bind(this));
                document.getElementById('performEDA').addEventListener('click', this.performEDA.bind(this));
                document.getElementById('trainML').addEventListener('click', this.trainML.bind(this));
                document.getElementById('performClustering').addEventListener('click', this.performClustering.bind(this));
                document.getElementById('createVisualizations').addEventListener('click', this.createVisualizations.bind(this));
                document.getElementById('generateGAN').addEventListener('click', this.generateGAN.bind(this));
                document.getElementById('getInsights').addEventListener('click', this.getInsights.bind(this));
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                const files = e.dataTransfer.files;
                this.uploadFiles(files);
            }

            handleFileSelect(e) {
                const files = e.target.files;
                this.uploadFiles(files);
            }

            async uploadFiles(files) {
                const allowedTypes = ['.pdf', '.docx', '.doc', '.pptx', '.ppt', '.txt', '.csv', '.xlsx', '.xls'];
                
                for (let file of files) {
                    const extension = '.' + file.name.split('.').pop().toLowerCase();
                    
                    if (!allowedTypes.includes(extension)) {
                        this.showStatus(`Skipped ${file.name}: Unsupported file type`, 'error');
                        continue;
                    }

                    try {
                        this.showStatus(`Uploading ${file.name}...`, 'info');
                        
                        const formData = new FormData();
                        formData.append('file', file);

                        const response = await fetch(`${this.baseUrl}/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.status === 'success') {
                            this.showStatus(`✅ Successfully uploaded and processed ${file.name}`, 'success');
                            
                            // Check if it's a data file and store metadata
                            if (['.csv', '.xlsx', '.xls'].includes(extension)) {
                                this.dataFiles.set(result.file_id, {
                                    filename: file.name,
                                    fileId: result.file_id,
                                    extension: extension
                                });
                            }
                        } else if (result.status === 'duplicate') {
                            this.showStatus(`⚠️ ${file.name} already exists in the system`, 'info');
                        } else {
                            this.showStatus(`❌ Failed to upload ${file.name}: ${result.message}`, 'error');
                        }
                    } catch (error) {
                        this.showStatus(`❌ Upload failed for ${file.name}: ${error.message}`, 'error');
                    }
                }
                
                // Refresh file list after uploads
                setTimeout(() => this.loadFileList(), 1000);
            }

            async loadFileList() {
                try {
                    const response = await fetch(`${this.baseUrl}/files`);
                    const data = await response.json();
                    
                    const fileList = document.getElementById('fileList');
                    const dataFileSelect = document.getElementById('dataFileSelect');
                    fileList.innerHTML = '';
                    dataFileSelect.innerHTML = '<option value="">Choose a data file...</option>';
                    
                    let hasDataFiles = false;
                    
                    if (data.files && Object.keys(data.files).length > 0) {
                        Object.entries(data.files).forEach(([fileId, fileInfo]) => {
                            const fileItem = document.createElement('div');
                            const extension = '.' + fileInfo.filename.split('.').pop().toLowerCase();
                            const isDataFile = ['.csv', '.xlsx', '.xls'].includes(extension);
                            
                            fileItem.className = `file-item ${isDataFile ? 'data-file' : ''}`;
                            
                            const uploadDate = new Date(fileInfo.upload_time).toLocaleDateString();
                            const fileSize = (fileInfo.file_size / 1024).toFixed(1);
                            
                            fileItem.innerHTML = `
                                <div class="file-info">
                                    <div class="file-name">${fileInfo.filename} ${isDataFile ? '📊' : '📄'}</div>
                                    <div class="file-meta">
                                        ${fileSize} KB • Uploaded ${uploadDate} 
                                        ${fileInfo.processed ? '• ✅ Processed' : '• ⏳ Processing'}
                                        ${isDataFile ? '• 📊 Data Analysis Available' : ''}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-secondary" onclick="ragInterface.removeFile('${fileId}')">
                                        🗑️
                                    </button>
                                </div>
                            `;
                            
                            fileList.appendChild(fileItem);
                            
                            // Add to data file selector if it's a data file
                            if (isDataFile) {
                                hasDataFiles = true;
                                this.dataFiles.set(fileId, {
                                    filename: fileInfo.filename,
                                    fileId: fileId,
                                    extension: extension
                                });
                                
                                const option = document.createElement('option');
                                option.value = fileId;
                                option.textContent = fileInfo.filename;
                                dataFileSelect.appendChild(option);
                            }
                        });
                        
                        // Show/hide data analysis section
                        const dataAnalysisSection = document.getElementById('dataAnalysisSection');
                        dataAnalysisSection.style.display = hasDataFiles ? 'block' : 'none';
                        
                    } else {
                        fileList.innerHTML = '<div class="status-message status-info">No documents uploaded yet</div>';
                    }
                } catch (error) {
                    console.error('Failed to load file list:', error);
                    document.getElementById('fileList').innerHTML = 
                        '<div class="status-message status-error">Failed to load file list</div>';
                }
            }

            async removeFile(fileId) {
                if (!confirm('Are you sure you want to remove this file?')) return;
                
                try {
                    const response = await fetch(`${this.baseUrl}/remove`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_id: fileId })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'removed') {
                        this.showStatus('File removed successfully', 'success');
                        this.dataFiles.delete(fileId);
                        this.loadFileList();
                    } else {
                        this.showStatus(`Failed to remove file: ${result.message}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error removing file: ${error.message}`, 'error');
                }
            }

            async submitQuery() {
                const queryInput = document.getElementById('queryInput');
                const query = queryInput.value.trim();
                
                if (!query) {
                    this.showStatus('Please enter a question', 'error');
                    return;
                }

                const submitButton = document.getElementById('submitQuery');
                const originalText = submitButton.innerHTML;
                
                try {
                    // Show loading state
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('analysisResults').style.display = 'none';
                    this.showStatus('Analyzing your question and searching through documents...', 'info');
                    
                    const response = await fetch(`${this.baseUrl}/query`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            query: query,
                            top_k: 10,
                            include_debug: false
                        })
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayQueryResults(result);
                    } else {
                        this.showStatus(`Query failed: ${result.answer || 'Unknown error'}`, 'error');
                    }
                    
                } catch (error) {
                    this.showStatus(`Error processing query: ${error.message}`, 'error');
                } finally {
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            }

            displayQueryResults(result) {
                document.getElementById('statusMessage').innerHTML = '';
                
                // Display answer
                const answerBox = document.getElementById('answerBox');
                answerBox.textContent = result.answer;
                
                // Display confidence
                if (result.confidence !== undefined) {
                    const confidenceMeter = document.getElementById('confidenceMeter');
                    const confidenceFill = document.getElementById('confidenceFill');
                    const confidenceText = document.getElementById('confidenceText');
                    
                    confidenceMeter.style.display = 'flex';
                    const percentage = Math.round(result.confidence * 100);
                    confidenceFill.style.width = `${percentage}%`;
                    confidenceText.textContent = `${percentage}%`;
                }
                
                // Display sources
                if (result.sources && result.sources.length > 0) {
                    const sourcesSection = document.getElementById('sourcesSection');
                    const sourcesList = document.getElementById('sourcesList');
                    
                    sourcesSection.style.display = 'block';
                    sourcesList.innerHTML = '';
                    
                    result.sources.forEach(source => {
                        const sourceItem = document.createElement('div');
                        sourceItem.className = 'source-item';
                        
                        sourceItem.innerHTML = `
                            <div class="source-header">
                                <div class="source-filename">${source.filename}</div>
                                <div class="source-score">${(source.relevance_score * 100).toFixed(1)}% match</div>
                            </div>
                            <div class="file-meta">
                                Chunk ${source.chunk_index + 1} of ${source.total_chunks} • 
                                Uploaded ${new Date(source.upload_time).toLocaleDateString()}
                            </div>
                        `;
                        
                        sourcesList.appendChild(sourceItem);
                    });
                }
                
                // Scroll to results
                document.getElementById('resultsSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }

            async handleDataFileSelection() {
                const selectedFileId = document.getElementById('dataFileSelect').value;
                if (!selectedFileId) return;

                // Load column information for ML training
                try {
                    const response = await fetch(`${this.baseUrl}/data-analysis/eda?file_id=${selectedFileId}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'success' && result.column_info) {
                            const targetColumnSelect = document.getElementById('targetColumn');
                            targetColumnSelect.innerHTML = '<option value="">Select target column...</option>';
                            
                            Object.keys(result.column_info).forEach(column => {
                                const option = document.createElement('option');
                                option.value = column;
                                option.textContent = column;
                                targetColumnSelect.appendChild(option);
                            });
                        }
                    }
                } catch (error) {
                    console.log('Could not load column information:', error);
                }
            }

            async performEDA() {
                const fileId = document.getElementById('dataFileSelect').value;
                if (!fileId) {
                    this.showStatus('Please select a data file first', 'error');
                    return;
                }

                const button = document.getElementById('performEDA');
                const originalText = button.innerHTML;
                
                try {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    this.showStatus('Performing Exploratory Data Analysis...', 'info');

                    const response = await fetch(`${this.baseUrl}/data-analysis/eda`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_id: fileId })
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayAnalysisResults('EDA Results', result);
                        this.showStatus('✅ EDA completed successfully', 'success');
                    } else {
                        this.showStatus(`EDA failed: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error performing EDA: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            async trainML() {
                const fileId = document.getElementById('dataFileSelect').value;
                const targetColumn = document.getElementById('targetColumn').value;
                const taskType = document.getElementById('taskType').value;

                if (!fileId) {
                    this.showStatus('Please select a data file first', 'error');
                    return;
                }

                if (!targetColumn) {
                    this.showStatus('Please select a target column', 'error');
                    return;
                }

                const button = document.getElementById('trainML');
                const originalText = button.innerHTML;
                
                try {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading"><div class="spinner"></div>Training...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    this.showStatus('Training machine learning models...', 'info');

                    const response = await fetch(`${this.baseUrl}/data-analysis/ml-training`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            file_id: fileId, 
                            target_column: targetColumn,
                            task_type: taskType
                        })
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayAnalysisResults('ML Training Results', result);
                        this.showStatus('✅ ML training completed successfully', 'success');
                    } else {
                        this.showStatus(`ML training failed: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error training ML models: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            async performClustering() {
                const fileId = document.getElementById('dataFileSelect').value;
                const numClusters = document.getElementById('numClusters').value || null;

                if (!fileId) {
                    this.showStatus('Please select a data file first', 'error');
                    return;
                }

                const button = document.getElementById('performClustering');
                const originalText = button.innerHTML;
                
                try {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading"><div class="spinner"></div>Clustering...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    this.showStatus('Performing clustering analysis...', 'info');

                    const response = await fetch(`${this.baseUrl}/data-analysis/clustering`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            file_id: fileId,
                            n_clusters: numClusters ? parseInt(numClusters) : null
                        })
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayAnalysisResults('Clustering Results', result);
                        this.showStatus('✅ Clustering analysis completed successfully', 'success');
                    } else {
                        this.showStatus(`Clustering failed: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error performing clustering: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            async createVisualizations() {
                const fileId = document.getElementById('dataFileSelect').value;

                if (!fileId) {
                    this.showStatus('Please select a data file first', 'error');
                    return;
                }

                const button = document.getElementById('createVisualizations');
                const originalText = button.innerHTML;
                
                try {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading"><div class="spinner"></div>Creating...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    this.showStatus('Creating advanced visualizations...', 'info');

                    const response = await fetch(`${this.baseUrl}/data-analysis/advanced-visualizations`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            file_id: fileId,
                            chart_types: null
                        })
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayAnalysisResults('Advanced Visualizations', result);
                        this.showStatus('✅ Visualizations created successfully', 'success');
                    } else {
                        this.showStatus(`Visualization failed: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error creating visualizations: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            async generateGAN() {
                const fileId = document.getElementById('dataFileSelect').value;

                if (!fileId) {
                    this.showStatus('Please select a data file first', 'error');
                    return;
                }

                const button = document.getElementById('generateGAN');
                const originalText = button.innerHTML;
                
                try {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading"><div class="spinner"></div>Generating...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    this.showStatus('Generating GAN visualization...', 'info');

                    const response = await fetch(`${this.baseUrl}/data-analysis/gan-visualization`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            file_id: fileId,
                            columns: null
                        })
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayAnalysisResults('GAN Visualization', result);
                        this.showStatus('✅ GAN visualization generated successfully', 'success');
                    } else {
                        this.showStatus(`GAN generation failed: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error generating GAN visualization: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            async getInsights() {
                const fileId = document.getElementById('dataFileSelect').value;

                if (!fileId) {
                    this.showStatus('Please select a data file first', 'error');
                    return;
                }

                const button = document.getElementById('getInsights');
                const originalText = button.innerHTML;
                
                try {
                    button.disabled = true;
                    button.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing...</div>';
                    
                    document.getElementById('resultsSection').style.display = 'block';
                    this.showStatus('Generating AI-powered insights...', 'info');

                    const response = await fetch(`${this.baseUrl}/data-analysis/insights/${fileId}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.displayAnalysisResults('AI Data Insights', result);
                        this.showStatus('✅ Insights generated successfully', 'success');
                    } else {
                        this.showStatus(`Insights generation failed: ${result.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    this.showStatus(`Error generating insights: ${error.message}`, 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            displayAnalysisResults(title, result) {
                const analysisResults = document.getElementById('analysisResults');
                const analysisContent = document.getElementById('analysisContent');
                
                analysisResults.style.display = 'block';
                analysisContent.innerHTML = '';

                // Hide regular answer sections
                document.getElementById('answerBox').style.display = 'none';
                document.getElementById('confidenceMeter').style.display = 'none';
                document.getElementById('sourcesSection').style.display = 'none';

                // Create title
                const titleElement = document.createElement('h3');
                titleElement.textContent = title;
                titleElement.style.marginBottom = '20px';
                titleElement.style.color = '#1e293b';
                analysisContent.appendChild(titleElement);

                // Display results based on type
                if (result.summary_statistics) {
                    this.displayEDAResults(result, analysisContent);
                } else if (result.model_results) {
                    this.displayMLResults(result, analysisContent);
                } else if (result.cluster_info) {
                    this.displayClusteringResults(result, analysisContent);
                } else if (result.insights) {
                    this.displayInsightsResults(result, analysisContent);
                } else if (result.visualizations) {
                    this.displayVisualizationResults(result, analysisContent);
                } else {
                    // Generic result display
                    const genericDiv = document.createElement('div');
                    genericDiv.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                    analysisContent.appendChild(genericDiv);
                }

                // Scroll to results
                analysisResults.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }

            displayEDAResults(result, container) {
                const stats = result.summary_statistics;
                
                // Dataset overview
                const overviewDiv = document.createElement('div');
                overviewDiv.className = 'chart-container';
                overviewDiv.innerHTML = `
                    <h4>📊 Dataset Overview</h4>
                    <p><strong>Shape:</strong> ${stats.dataset_info.shape[0]} rows × ${stats.dataset_info.shape[1]} columns</p>
                    <p><strong>Memory Usage:</strong> ${stats.dataset_info.memory_usage_mb} MB</p>
                    <p><strong>Missing Values:</strong> ${stats.dataset_info.missing_values_total}</p>
                `;
                container.appendChild(overviewDiv);

                // Column information
                if (result.column_info) {
                    const columnsDiv = document.createElement('div');
                    columnsDiv.className = 'chart-container';
                    columnsDiv.innerHTML = '<h4>📋 Column Information</h4>';
                    
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.innerHTML = `
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 10px; text-align: left;">Column</th>
                            <th style="padding: 10px; text-align: left;">Type</th>
                            <th style="padding: 10px; text-align: left;">Non-Null Count</th>
                            <th style="padding: 10px; text-align: left;">Missing %</th>
                        </tr>
                    `;
                    
                    Object.entries(result.column_info).forEach(([column, info]) => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e2e8f0';
                        row.innerHTML = `
                            <td style="padding: 8px;">${column}</td>
                            <td style="padding: 8px;">${info.dtype}</td>
                            <td style="padding: 8px;">${info.non_null_count}</td>
                            <td style="padding: 8px;">${((info.missing_count / stats.dataset_info.shape[0]) * 100).toFixed(1)}%</td>
                        `;
                        table.appendChild(row);
                    });
                    
                    columnsDiv.appendChild(table);
                    container.appendChild(columnsDiv);
                }

                // Display any visualization paths
                if (result.visualization_paths) {
                    const vizDiv = document.createElement('div');
                    vizDiv.className = 'chart-container';
                    vizDiv.innerHTML = '<h4>📈 Generated Visualizations</h4>';
                    
                    result.visualization_paths.forEach(path => {
                        const p = document.createElement('p');
                        p.innerHTML = `📊 Visualization saved: <code>${path}</code>`;
                        vizDiv.appendChild(p);
                    });
                    
                    container.appendChild(vizDiv);
                }
            }

            displayMLResults(result, container) {
                const resultsDiv = document.createElement('div');
                resultsDiv.className = 'chart-container';
                resultsDiv.innerHTML = `
                    <h4>🤖 Model Performance</h4>
                    <p><strong>Task Type:</strong> ${result.task_type}</p>
                    <p><strong>Best Model:</strong> ${result.best_model}</p>
                `;

                if (result.model_results) {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.innerHTML = `
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 10px; text-align: left;">Model</th>
                            <th style="padding: 10px; text-align: left;">Score</th>
                            <th style="padding: 10px; text-align: left;">Training Time</th>
                        </tr>
                    `;
                    
                    Object.entries(result.model_results).forEach(([model, metrics]) => {
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid #e2e8f0';
                        const score = metrics.accuracy || metrics.r2_score || metrics.score || 'N/A';
                        const time = metrics.training_time || 'N/A';
                        row.innerHTML = `
                            <td style="padding: 8px;">${model}</td>
                            <td style="padding: 8px;">${typeof score === 'number' ? score.toFixed(4) : score}</td>
                            <td style="padding: 8px;">${time}</td>
                        `;
                        table.appendChild(row);
                    });
                    
                    resultsDiv.appendChild(table);
                }

                container.appendChild(resultsDiv);
            }

            displayClusteringResults(result, container) {
                const clusterDiv = document.createElement('div');
                clusterDiv.className = 'chart-container';
                clusterDiv.innerHTML = `
                    <h4>🎯 Clustering Results</h4>
                    <p><strong>Number of Clusters:</strong> ${result.cluster_info.n_clusters}</p>
                    <p><strong>Silhouette Score:</strong> ${result.cluster_info.silhouette_score.toFixed(4)}</p>
                `;

                if (result.cluster_info.cluster_sizes) {
                    const sizesP = document.createElement('p');
                    sizesP.innerHTML = `<strong>Cluster Sizes:</strong> ${result.cluster_info.cluster_sizes.join(', ')}`;
                    clusterDiv.appendChild(sizesP);
                }

                container.appendChild(clusterDiv);
            }

            displayInsightsResults(result, container) {
                const insights = result.insights;
                
                // Overview
                const overviewDiv = document.createElement('div');
                overviewDiv.className = 'chart-container';
                overviewDiv.innerHTML = `
                    <h4>🧠 Dataset Overview</h4>
                    <p><strong>Total Rows:</strong> ${insights.dataset_overview.total_rows}</p>
                    <p><strong>Total Columns:</strong> ${insights.dataset_overview.total_columns}</p>
                    <p><strong>Data Quality Score:</strong> ${insights.data_quality.completeness_score.toFixed(1)}%</p>
                `;
                container.appendChild(overviewDiv);

                // Key findings
                if (insights.key_findings) {
                    const findingsDiv = document.createElement('div');
                    findingsDiv.className = 'chart-container';
                    findingsDiv.innerHTML = '<h4>🔍 Key Findings</h4>';
                    
                    const findingsList = document.createElement('ul');
                    insights.key_findings.forEach(finding => {
                        const li = document.createElement('li');
                        li.textContent = finding;
                        li.style.marginBottom = '8px';
                        findingsList.appendChild(li);
                    });
                    
                    findingsDiv.appendChild(findingsList);
                    container.appendChild(findingsDiv);
                }

                // Recommendations
                if (insights.recommendations) {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'chart-container';
                    recDiv.innerHTML = '<h4>💡 Recommendations</h4>';
                    
                    const recList = document.createElement('ul');
                    insights.recommendations.forEach(rec => {
                        const li = document.createElement('li');
                        li.textContent = rec;
                        li.style.marginBottom = '8px';
                        recList.appendChild(li);
                    });
                    
                    recDiv.appendChild(recList);
                    container.appendChild(recDiv);
                }
            }

            displayVisualizationResults(result, container) {
                const vizDiv = document.createElement('div');
                vizDiv.className = 'chart-container';
                vizDiv.innerHTML = '<h4>📈 Visualization Results</h4>';

                if (result.visualization_paths) {
                    result.visualization_paths.forEach(path => {
                        const p = document.createElement('p');
                        p.innerHTML = `📊 Generated: <code>${path}</code>`;
                        vizDiv.appendChild(p);
                    });
                }

                if (result.visualizations) {
                    Object.entries(result.visualizations).forEach(([type, info]) => {
                        const p = document.createElement('p');
                        p.innerHTML = `✅ ${type}: ${info.description || 'Generated successfully'}`;
                        vizDiv.appendChild(p);
                    });
                }

                container.appendChild(vizDiv);
            }

            showStatus(message, type) {
                const statusMessage = document.getElementById('statusMessage');
                statusMessage.className = `status-message status-${type}`;
                statusMessage.textContent = message;
                
                // Auto-hide success messages
                if (type === 'success') {
                    setTimeout(() => {
                        statusMessage.innerHTML = '';
                    }, 3000);
                }
            }
        }

        // Initialize the application
        const ragInterface = new EnhancedRAGInterface();
    </script>
</body>
</html>